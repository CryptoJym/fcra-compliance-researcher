<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>FCRA Researcher - Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 24px; }
    h1 { font-size: 22px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #e5e7eb; padding: 8px 10px; font-size: 14px; }
    th { background: #f3f4f6; text-align: left; }
    .badge { padding: 2px 8px; border-radius: 9999px; font-size: 12px; }
    .pending { background: #fef9c3; }
    .in_progress { background: #dbeafe; }
    .completed { background: #dcfce7; }
    .error { background: #fee2e2; }
    .pill { padding: 2px 6px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 12px; }
  </style>
</head>
<body>
  <h1>FCRA Researcher - Recent Runs</h1>
  <div style="margin:12px 0; display:flex; gap:12px; align-items:center;">
    <form method="get" action="/">
      <label>Status
        <select name="status">
          <option value="">All</option>
          <option value="pending" {% if status_filter=='pending' %}selected{% endif %}>Pending</option>
          <option value="in_progress" {% if status_filter=='in_progress' %}selected{% endif %}>In Progress</option>
          <option value="completed" {% if status_filter=='completed' %}selected{% endif %}>Completed</option>
          <option value="error" {% if status_filter=='error' %}selected{% endif %}>Error</option>
        </select>
      </label>
      <label>Type
        <select name="type">
          <option value="">All</option>
          <option value="state" {% if type_filter=='state' %}selected{% endif %}>State</option>
          <option value="county" {% if type_filter=='county' %}selected{% endif %}>County</option>
          <option value="city" {% if type_filter=='city' %}selected{% endif %}>City</option>
        </select>
      </label>
      <button type="submit">Apply</button>
    </form>
    <div style="margin-left:auto;">
      <strong>Completed:</strong> {{ counts.completed or 0 }} / {{ counts.completed + counts.in_progress + counts.pending + counts.error }} ({{ percent }}%)
    </div>
  </div>
  <table>
    <thead>
      <tr>
        <th>Jurisdiction</th>
        <th>Status</th>
        <th>Started</th>
        <th>Completed</th>
        <th>Duration</th>
        <th>Metrics</th>
        <th>Error</th>
        <th>Review</th>
      </tr>
    </thead>
    <tbody>
    {% for r in rows %}
      <tr>
        <td>{{ r.jurisdiction_path }}</td>
        <td><span class="badge {{ r.status }}">{{ r.status }}</span></td>
        <td>{{ r.started_at }}</td>
        <td>{{ r.completed_at if r.completed_at else '' }}</td>
        <td>{{ r.duration }}</td>
        <td><pre style="white-space: pre-wrap;">{{ r.metrics }}</pre></td>
        <td>{{ r.error if r.error else '' }}</td>
        <td>
          {% if r.review_status %}<span class="pill">{{ r.review_status }}</span>{% endif %}
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</body>
</html>
